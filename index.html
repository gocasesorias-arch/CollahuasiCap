<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Certificaciones Collahuasi</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --color-primary: #275317;
            --color-secondary: #3B7D23;
            --color-accent: #8ED973;
            --color-warning: #DE990E;
        }
        body {
            background-color: #f5f5f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .header-collahuasi {
            background-color: var(--color-primary);
            color: white;
            padding: 2rem 0 1.5rem 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .collahuasi-logo {
            display: block;
            margin: 0 auto 1.2rem auto;
            max-width: 320px;
            width: 100%;
            height: auto;
            border-radius: 20px;
        }
        .title-section {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .search-box {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .cert-card {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid;
            transition: all 0.3s;
            margin-bottom: 1rem;
        }
        .cert-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        .cert-card.vigente {
            border-left-color: var(--color-accent);
        }
        .cert-card.vencido {
            border-left-color: #ff8800;
            background-color: #fff1d6;
        }
        .badge-vigente {
            background-color: #d4edda;
            color: #155724;
        }
        .badge-vencido {
            background-color: #ff8800;
            color: #fff;
        }
        .status-badge {
            background-color: #d4edda;
            color: #155724;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .section-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 2rem 0 1rem;
        }
        .section-line {
            width: 4px;
            height: 32px;
            border-radius: 2px;
        }
        .btn-download {
            background-color: var(--color-secondary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-download:hover {
            opacity: 0.9;
        }
        .btn-pdf {
            background-color: #b02a37; /* rojo sobrio para PDF */
            color: white;
            border: none;
            padding: 0.45rem 0.9rem;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-pdf:hover { opacity: 0.92; }

        .modal-step {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .step-number {
            width: 32px;
            height: 32px;
            background-color: var(--color-secondary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--color-secondary);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
        }
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header-collahuasi">
        <div class="container">
            <img src="https://raw.githubusercontent.com/gocasesorias-arch/CollahuasiCap/main/LOGO2.0.png" alt="Collahuasi" class="collahuasi-logo">
            <div class="title-section">
                <i class="fas fa-hard-hat" style="font-size: 3rem; color: var(--color-warning);"></i>
                <div style="flex: 1;">
                    <h1 class="mb-0">Certificaciones Collahuasi</h1>
                    <p class="mb-0 opacity-75" style="font-size: 0.9rem;">Sistema de Consulta de Certificaciones</p>
                </div>
                <div id="statusContainer"></div>
            </div>

            <div id="searchContainer" class="search-box mt-4" style="display: none;">
                <div class="row g-2">
                    <div class="col-md-10">
                        <input type="text" id="rutInput" class="form-control form-control-lg" 
                               placeholder="Ingrese RUT (Ej: 12.345.678-9)" maxlength="12">
                    </div>
                    <div class="col-md-2">
                        <button id="btnSearch" class="btn btn-lg w-100" style="background-color: var(--color-secondary); color: white;">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                    </div>
                </div>
            </div>

            <div id="noDataMessage" class="search-box mt-4 text-center">
                <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: var(--color-warning);"></i>
                <p class="text-dark mt-3 mb-1">Sistema sin datos cargados</p>
                <p class="text-muted small">Espere unos segundos mientras se cargan los datos automáticamente</p>
            </div>
        </div>
    </div>

    <!-- Results Container -->
    <div class="container my-4">
        <div id="loadingContainer" style="display: none;">
            <div class="loading-spinner"></div>
            <p class="text-center text-muted">Buscando certificaciones...</p>
        </div>

        <div id="resultsContainer"></div>

        <div id="emptyResults" style="display: none;" class="empty-state">
            <i class="fas fa-search text-muted"></i>
            <h3 class="text-muted">Busque certificaciones por RUT</h3>
            <p class="text-muted">Ingrese el RUT del trabajador para ver sus certificaciones</p>
        </div>
    </div>

    <!-- Guide Modal -->
    <div class="modal fade" id="guideModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background-color: var(--color-primary); color: white;">
                    <h5 class="modal-title" id="guideModalTitle"></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="guideModalBody"></div>
                <div class="modal-footer">
                    <a id="guideLink" href="#" target="_blank" class="btn" style="background-color: var(--color-secondary); color: white;">
                        <i class="fas fa-external-link-alt"></i> Ir al Portal de Descarga
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Dependencias -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- jsPDF + AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>


    <script>
        // URL del archivo JSON en GitHub
        const jsonUrl = "https://raw.githubusercontent.com/gocasesorias-arch/CollahuasiCap/main/tableConvert.com_jt1fa1.json";
        let allData = [];
        let dataLoaded = false;

        // RUTA LOCAL DEL LOGO (EN EL CONTENEDOR). 
        // => Usar EXACTAMENTE la ruta que subiste: /mnt/data/18dba182-1812-4abe-b0a2-ec4ea591473e.png
        // (el entorno de ejecución transformará esta ruta a una URL accesible)
        const localLogoPath = "/mnt/data/18dba182-1812-4abe-b0a2-ec4ea591473e.png";

        // Categorías (sin cambios funcionales)
        const categorias = {
            equiposMoviles: [
                "Grúas móviles tipo AT", "Operador Rigger", "OPERAR CAMIÓN PLUMA",
                "OPERAR GRÚA ALZAHOMBRE", "OPERAR GRÚA HORQUILLA", "OPERAR GRÚA PEDESTAL",
                "OPERAR GRÚA PLUMA", "OPERAR PUENTE GRÚA", "OPERAR RETROEXCAVADORA","OPERACIÓN CON GRÚA HORQUILLA"
            ],
            epf: [
                "AISLAMIENTO, BLOQUEO Y PRUEBAS DE ENERGÍA EPF#5",
                "PROTECCIÓN CONTRA CAÍDAS EPF#6",
                "TÉCNICAS Y MANIOBRAS DE IZAJE Y LEVANTE (RIGGER)",
                "TÉCNICAS Y MANIOBRAS DE IZAJE Y LEVANTE EPF 7 (RIGGER)",
                "PROTECCIÓN CONTRA CAÍDAS EPF#6 PARA SPS"
            ]
        };

        const guides = {
            equiposMoviles: {
                title: "Guía de Descarga - Equipos Móviles",
                link: "https://participantes.ceim.cl/index.asp",
                steps: [
                    "Ingrese al portal CEIM haciendo clic en el botón de abajo",
                    "Inicie sesión con sus credenciales (Usuario: Rut y sus 4 primeros digitos)",
                    "Navegue a la Pestaña Cursos, sección 'Cursos'",
                    "Busque su certificación de equipos móviles y presione la lupa",
                    "Haga clic en 'Acreditativo' en el icono PDF",
                    "El certificado se descargará automáticamente"
                ]
            },
            epf: {
                title: "Guía de Descarga - Estándares de Prevención de Fatalidades",
                link: "https://certificate.fsmspa.com/",
                steps: [
                    "Acceda al portal FSM haciendo clic en el botón de abajo",
                    "Ingrese su RUT",
                    "Seleccione el certificado EPF que desea descargar",
                    "Verifique que el certificado esté vigente",
                    "Presione 'Descargar Certificado'",
                    "Guarde el archivo PDF en su computador"
                ]
            },
            otros: {
                title: "Guía de Descarga - Otras Certificaciones",
                link: "https://participantes.ceim.cl/index.asp",
                steps: [
                    "Ingrese al portal CEIM haciendo clic en el botón de abajo",
                    "Inicie sesión con sus credenciales",
                    "Navegue a la sección 'Mis Certificaciones'",
                    "Busque su certificación de equipos móviles",
                    "Haga clic en 'Descargar' para obtener el PDF",
                    "El certificado se descargará automáticamente"
                ]
            }
        };

        // Formatear RUT (sin cambios)
        function formatRut(value) {
            const cleaned = value.replace(/[^0-9kK]/g, '');
            if (cleaned.length <= 1) return cleaned;
            const dv = cleaned.slice(-1);
            const numbers = cleaned.slice(0, -1);
            let formatted = '';
            for (let i = numbers.length - 1, j = 0; i >= 0; i--, j++) {
                if (j > 0 && j % 3 === 0) formatted = '.' + formatted;
                formatted = numbers[i] + formatted;
            }
            return formatted + '-' + dv;
        }

        function categorizarCertificado(nombre) {
            if (!nombre) return 'otros';
            const nombreUpper = nombre.toUpperCase();
            if (categorias.equiposMoviles.some(eq => nombreUpper.includes(eq.toUpperCase()))) {
                return 'equiposMoviles';
            }
            if (categorias.epf.some(epf => nombreUpper.includes(epf.toUpperCase()))) {
                return 'epf';
            }
            return 'otros';
        }

        function updateUI() {
            const statusContainer = document.getElementById('statusContainer');
            const searchContainer = document.getElementById('searchContainer');
            const noDataMessage = document.getElementById('noDataMessage');
            const emptyResults = document.getElementById('emptyResults');

            if (dataLoaded && allData.length > 0) {
                statusContainer.innerHTML = `
                    <div class="status-badge">
                        <i class="fas fa-check-circle"></i>
                        <span><strong>Sistema Activo</strong></span>
                    </div>
                    <div class="text-white-50 small text-end mt-1">${allData.length} registros</div>
                `;
                searchContainer.style.display = 'block';
                noDataMessage.style.display = 'none';
                emptyResults.style.display = 'block';
            } else {
                statusContainer.innerHTML = `
                    <div class="status-badge" style="background-color:#fff3cd;color:#856404;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span><strong>Cargando datos...</strong></span>
                    </div>
                `;
                searchContainer.style.display = 'none';
                noDataMessage.style.display = 'block';
                emptyResults.style.display = 'none';
            }
        }

        // Cargar JSON
        async function autoLoadJSON() {
            try {
                const response = await fetch(jsonUrl);
                if (!response.ok) throw new Error('No se pudo descargar el archivo JSON');
                allData = await response.json();
                dataLoaded = true;
                updateUI();
            } catch (error) {
                console.error("Error al cargar el JSON:", error);
                const statusContainer = document.getElementById('statusContainer');
                statusContainer.innerHTML = `
                    <div class="status-badge" style="background-color:#f8d7da;color:#721c24;">
                        <i class="fas fa-times-circle"></i>
                        <span><strong>Error cargando datos</strong></span>
                    </div>
                `;
            }
        }

        autoLoadJSON();

        // Eventos
        document.getElementById('rutInput').addEventListener('input', function(e) {
            e.target.value = formatRut(e.target.value);
        });
        document.getElementById('rutInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') searchCertifications();
        });
        document.getElementById('btnSearch').addEventListener('click', searchCertifications);

        function searchCertifications() {
            const rutInput = document.getElementById('rutInput').value;
            const loadingContainer = document.getElementById('loadingContainer');
            const resultsContainer = document.getElementById('resultsContainer');
            const emptyResults = document.getElementById('emptyResults');

            if (rutInput.length < 9) return;

            loadingContainer.style.display = 'block';
            resultsContainer.innerHTML = '';
            emptyResults.style.display = 'none';

            setTimeout(() => {
                const cleanRut = rutInput.replace(/\./g, '').replace(/-/g, '').toUpperCase().trim();
                const results = allData.filter(item => {
                    if (!item.RUT) return false;
                    const itemRut = String(item.RUT).replace(/\./g, '').replace(/-/g, '').toUpperCase().trim();
                    return itemRut === cleanRut;
                });

                loadingContainer.style.display = 'none';

                if (results.length === 0) {
                    resultsContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-times-circle text-muted"></i>
                            <h3 class="text-muted">No se encontraron certificaciones</h3>
                            <p class="text-muted">Verifique que el RUT ingresado sea correcto</p>
                            <p class="text-muted small">RUT buscado: ${rutInput}</p>
                        </div>
                    `;
                    return;
                }

                const categorized = { equiposMoviles: [], epf: [], otros: [] };

                results.forEach(cert => {
                    const categoria = categorizarCertificado(cert.Certificado);
                    const fechaTermino = new Date(cert['Fecha Termino Vigencia']);
                    const vigente = fechaTermino >= new Date();

                    categorized[categoria].push({
                        nombre: cert.Certificado,
                        fechaInicio: new Date(cert['Fecha Inicio Vigencia']).toLocaleDateString('es-CL'),
                        fechaTermino: fechaTermino.toLocaleDateString('es-CL'),
                        vigente: vigente,
                        trabajador: cert.Trabajador,
                        posicion: cert.Posición || cert.Posicion,
                        otec: cert.Otec
                    });
                });

                displayResults(categorized);
            }, 400);
        }

        // Mostrar resultados y botón PDF (debajo de Datos del Trabajador)
        function displayResults(categorized) {
            const resultsContainer = document.getElementById('resultsContainer');
            let html = '';

            // Datos del trabajador
            const firstCert = categorized.equiposMoviles[0] || categorized.epf[0] || categorized.otros[0];
            if (firstCert) {
                html += `
                    <div class="cert-card mb-4">
                        <h4 style="color: var(--color-primary);">Datos del Trabajador</h4>
                        <p class="mb-1"><strong>Nombre:</strong> ${firstCert.trabajador}</p>
                        <p class="mb-0"><strong>Posición:</strong> ${firstCert.posicion}</p>

                        <!-- BOTÓN PDF (Opc 1: Debajo de Datos del Trabajador) -->
                        <div class="mt-3">
                            <button class="btn-pdf" onclick="generarPDF()">
                                <i class="fas fa-file-pdf"></i> Descargar Certificado Profesional PDF
                            </button>
                        </div>
                    </div>
                `;
            }

            // Equipos Móviles
            if (categorized.equiposMoviles.length > 0) {
                html += `
                    <div class="section-header">
                        <div class="section-line" style="background-color: var(--color-secondary);"></div>
                        <h2 style="color: var(--color-primary);">Equipos Móviles</h2>
                        <span class="badge" style="background-color: var(--color-accent); color: var(--color-primary);">
                            ${categorized.equiposMoviles.length}
                        </span>
                    </div>
                    <div class="row">
                        ${categorized.equiposMoviles.map(cert => createCertCard(cert, 'equiposMoviles')).join('')}
                    </div>
                `;
            }

            // EPF
            if (categorized.epf.length > 0) {
                html += `
                    <div class="section-header">
                        <div class="section-line" style="background-color: var(--color-warning);"></div>
                        <h2 style="color: var(--color-primary);">Estándares de Prevención de Fatalidades (EPF)</h2>
                        <span class="badge" style="background-color: rgba(222, 153, 14, 0.25); color: var(--color-warning);">
                            ${categorized.epf.length}
                        </span>
                    </div>
                    <div class="row">
                        ${categorized.epf.map(cert => createCertCard(cert, 'epf')).join('')}
                    </div>
                `;
            }

            // Otros
            if (categorized.otros.length > 0) {
                html += `
                    <div class="section-header">
                        <div class="section-line" style="background-color: var(--color-secondary);"></div>
                        <h2 style="color: var(--color-primary);">Otras Certificaciones</h2>
                        <span class="badge" style="background-color: var(--color-accent); color: var(--color-primary);">
                            ${categorized.otros.length}
                        </span>
                    </div>
                    <div class="row">
                        ${categorized.otros.map(cert => createCertCard(cert, 'otros')).join('')}
                    </div>
                `;
            }

            resultsContainer.innerHTML = html;
        }

        function createCertCard(cert, categoria) {
            return `
                <div class="col-md-4">
                    <div class="cert-card ${cert.vigente ? 'vigente' : 'vencido'}">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="mb-0 flex-grow-1">${cert.nombre}</h6>
                            <i class="fas fa-${cert.vigente ? 'check-circle text-success' : 'exclamation-circle text-warning'}"></i>
                        </div>
                        <div class="small text-muted mb-2">
                            <p class="mb-1"><strong>Inicio:</strong> ${cert.fechaInicio}</p>
                            <p class="mb-1"><strong>Vencimiento:</strong> ${cert.fechaTermino}</p>
                            <p class="mb-0"><strong>OTEC:</strong> ${cert.otec}</p>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="badge ${cert.vigente ? 'badge-vigente' : 'badge-vencido'}">
                                ${cert.vigente ? 'VIGENTE' : 'VENCIDO'}
                            </span>
                            <button class="btn-download" onclick="showGuide('${categoria}')">
                                <i class="fas fa-download"></i> Descargar
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function showGuide(type) {
            const guide = guides[type];
            const modal = new bootstrap.Modal(document.getElementById('guideModal'));
            document.getElementById('guideModalTitle').textContent = guide.title;
            document.getElementById('guideLink').href = guide.link;
            let stepsHtml = '';
            guide.steps.forEach((step, index) => {
                stepsHtml += `
                    <div class="modal-step">
                        <div class="step-number">${index + 1}</div>
                        <p class="mb-0">${step}</p>
                    </div>
                `;
            });
            stepsHtml += `
                <div class="alert alert-info mt-3">
                    <strong>Nota:</strong> Si tiene problemas para descargar su certificado, 
                    contacte al departamento de capacitación.
                </div>
            `;
            document.getElementById('guideModalBody').innerHTML = stepsHtml;
            modal.show();
        }

        /* -------------------------
           FUNCIONES PDF (jsPDF + autotable)
           ------------------------- */

        // Convierte una ruta (local) a dataURL cargando la imagen con fetch -> blob -> base64
        async function imageUrlToDataUrl(url) {
            try {
                const resp = await fetch(url);
                const blob = await resp.blob();
                return await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result.toString());
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            } catch (e) {
                console.error("No se pudo cargar la imagen:", url, e);
                return null;
            }
        }

        async function generarPDF() {
            // Obtener jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF("p", "pt", "letter");

            // Cargar logo desde la ruta local (el entorno servirá la ruta)
            const logoData = await imageUrlToDataUrl(localLogoPath);

            // Encabezado - barra verde y logo
            doc.setFillColor(39, 83, 23);
            doc.rect(0, 0, doc.internal.pageSize.getWidth(), 80, "F");

            if (logoData) {
                // agrega logo en el header
                doc.addImage(logoData, "PNG", 30, 14, 140, 50);
            }

            // Título sobre el encabezado (texto blanco)
            doc.setFontSize(18);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(255, 255, 255);
            doc.text("Certificado de Competencias y Capacitación", 200, 48);

            // Extraer datos del DOM (nombre y posición desde la tarjeta)
            const workerCard = document.querySelector("#resultsContainer .cert-card");
            let trabajador = "Sin Nombre";
            let posicion = "";
            if (workerCard) {
                const nombreElem = workerCard.querySelector("p strong");
                if (nombreElem && nombreElem.parentNode) {
                    // el texto después del <strong>Nombre:</strong>
                    const full = workerCard.querySelector("p").textContent || "";
                    // split para obtener el valor luego de "Nombre:"
                    trabajador = full.replace("Nombre:", "").trim();
                }
                const posElem = workerCard.querySelectorAll("p")[1];
                if (posElem) posicion = posElem.textContent.replace("Posición:", "").trim();
            }

            // Info trabajador en PDF
            doc.setDrawColor(0);
            doc.setFontSize(11);
            doc.setTextColor(0,0,0);
            doc.text(`Trabajador: ${trabajador}`, 40, 110);
            if (posicion) doc.text(`Posición: ${posicion}`, 40, 126);

            // Recolectar certificaciones visibles en pantalla
            const certRows = [];
            document.querySelectorAll("#resultsContainer .cert-card").forEach(card => {
                // ignorar la tarjeta de datos del trabajador (tiene h4)
                if (card.querySelector("h4")) return;
                const nombre = card.querySelector("h6") ? card.querySelector("h6").innerText.trim() : "";
                const parrafos = card.querySelectorAll(".small p, .small");
                // fallback: usamos selectores concretos
                const inicio = card.querySelector(".small p:nth-child(1)") ? card.querySelector(".small p:nth-child(1)").innerText.replace("Inicio:", "").trim() : (card.querySelector("p.mb-1") ? card.querySelector("p.mb-1").innerText.replace("Inicio:", "").trim() : "");
                const venc = card.querySelector(".small p:nth-child(2)") ? card.querySelector(".small p:nth-child(2)").innerText.replace("Vencimiento:", "").trim() : "";
                const otec = card.querySelector(".small p:nth-child(3)") ? card.querySelector(".small p:nth-child(3)").innerText.replace("OTEC:", "").trim() : "";
                const estado = card.querySelector(".badge") ? card.querySelector(".badge").innerText.trim() : "";
                if (nombre) certRows.push([nombre, inicio, venc, otec, estado]);
            });

            // Si no hay rows por el selector anterior (por seguridad), parsear con otro método
            if (certRows.length === 0) {
                document.querySelectorAll("#resultsContainer .col-md-4").forEach(col => {
                    const card = col.querySelector(".cert-card");
                    if (!card || card.querySelector("h4")) return;
                    const nombre = card.querySelector("h6") ? card.querySelector("h6").innerText.trim() : "";
                    const inicio = card.querySelector("p.mb-1") ? card.querySelector("p.mb-1").innerText.replace("Inicio:", "").trim() : "";
                    const venc = card.querySelector("p.mb-1:nth-of-type(2)") ? card.querySelector("p.mb-1:nth-of-type(2)").innerText.replace("Vencimiento:", "").trim() : "";
                    const otec = card.querySelector("p.mb-0") ? card.querySelector("p.mb-0").innerText.replace("OTEC:", "").trim() : "";
                    const estado = card.querySelector(".badge") ? card.querySelector(".badge").innerText.trim() : "";
                    if (nombre) certRows.push([nombre, inicio, venc, otec, estado]);
                });
            }

            // Tabla con autotable
            doc.autoTable({
                startY: 150,
                head: [["Certificación", "Inicio", "Vencimiento", "OTEC", "Estado"]],
                body: certRows,
                styles: { fontSize: 10, cellPadding: 6 },
                headStyles: { fillColor: [39, 83, 23], textColor: [255,255,255], halign: 'left' },
                alternateRowStyles: { fillColor: [245,245,245] },
                margin: { left: 40, right: 40 }
            });

            // Fecha de emisión
            const hoy = new Date().toLocaleDateString("es-CL");
            const afterTableY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 20 : 300;
            doc.setFontSize(11);
            doc.setTextColor(0,0,0);
            doc.text(`Emitido el ${hoy}`, 40, afterTableY);

            // Firma (texto) y línea
            const firmaY = afterTableY + 50;
            doc.setDrawColor(0);
            doc.setLineWidth(0.5);
            doc.line(40, firmaY, 250, firmaY);
            doc.setFont("helvetica", "bold");
            doc.text("Capacitación Collahuasi", 40, firmaY + 16);

            // Sello (marca de agua)
            if (logoData) {
                try {
                    // Intento usar baja opacidad (setGState). Si falla, la imagen se dibuja normalmente.
                    if (doc.context && typeof doc.context.pdfLib === "undefined") {
                        // algunos entornos no permiten setGState; intentar sin opacidad
                        doc.addImage(logoData, "PNG", (doc.internal.pageSize.getWidth()/2) - 130, 260, 260, 100, undefined, "FAST");
                    } else {
                        // si setGState está disponible (nuevas versiones)
                        if (doc.setGState) {
                            const gState = { opacity: 0.12 };
                            try {
                                doc.setGState(new doc.GState(gState));
                                doc.addImage(logoData, "PNG", (doc.internal.pageSize.getWidth()/2) - 130, 260, 260, 100);
                                doc.setGState(new doc.GState({ opacity: 1 }));
                            } catch (e) {
                                // fallback sin opacidad
                                doc.addImage(logoData, "PNG", (doc.internal.pageSize.getWidth()/2) - 130, 260, 260, 100);
                            }
                        } else {
                            // fallback normal
                            doc.addImage(logoData, "PNG", (doc.internal.pageSize.getWidth()/2) - 130, 260, 260, 100);
                        }
                    }
                } catch (err) {
                    // si algo falla, dibujamos sin opacidad
                    doc.addImage(logoData, "PNG", (doc.internal.pageSize.getWidth()/2) - 130, 260, 260, 100);
                }
            }

            // Guardar PDF
            const safeName = trabajador.replace(/[^a-z0-9_\-]/gi, '_');
            doc.save(`Certificado_${safeName}.pdf`);
        }

        // Inicializa UI
        updateUI();
        // =============================
//   Generador de PDF Profesional
// =============================

async function generarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("p", "pt", "letter");

    // LOGO desde tu repositorio
    const logoUrl = "https://raw.githubusercontent.com/gocasesorias-arch/CollahuasiCap/main/LOGO2.0.png";
    const logo = await loadImage(logoUrl);

    // Encabezado
    doc.setFillColor(39, 83, 23);
    doc.rect(0, 0, 612, 80, "F");
    doc.addImage(logo, "PNG", 30, 15, 140, 50);

    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);
    doc.setTextColor(255, 255, 255);
    doc.text("Certificado de Competencias y Capacitación", 200, 50);

    // Obtener datos trabajador
    const trabajadorCard = document.querySelector(".cert-card");
    const trabajadorNombre = trabajadorCard.querySelectorAll("p")[0].innerText.replace("Nombre:", "").trim();
    const trabajadorPosicion = trabajadorCard.querySelectorAll("p")[1].innerText.replace("Posición:", "").trim();

    doc.setFontSize(12);
    doc.setTextColor(0, 0, 0);
    doc.text(`Trabajador: ${trabajadorNombre}`, 40, 110);
    doc.text(`Posición: ${trabajadorPosicion}`, 40, 130);

    // Extraer certificaciones
    const certs = [];
    document.querySelectorAll(".cert-card").forEach(card => {
        const titleElement = card.querySelector("h6");
        if (!titleElement) return;

        const nombre = titleElement.textContent.trim();
        const datos = card.querySelectorAll("p");
        const inicio = datos[0].textContent.replace("Inicio:", "").trim();
        const venc = datos[1].textContent.replace("Vencimiento:", "").trim();
        const otec = datos[2].textContent.replace("OTEC:", "").trim();
        const estado = card.querySelector(".badge").textContent.trim();

        certs.push([nombre, inicio, venc, otec, estado]);
    });

    // Tabla
    doc.autoTable({
        startY: 160,
        head: [["Certificación", "Inicio", "Vencimiento", "OTEC", "Estado"]],
        body: certs,
        styles: { fontSize: 10 },
        headStyles: { fillColor: [39, 83, 23], textColor: [255, 255, 255] },
        alternateRowStyles: { fillColor: [240, 240, 240] }
    });

    // Sello
    doc.setGState(new doc.GState({ opacity: 0.15 }));
    doc.addImage(logo, "PNG", 180, 350, 250, 100);
    doc.setGState(new doc.GState({ opacity: 1 }));

    // Firma
    const finalY = doc.lastAutoTable.finalY + 60;
    doc.line(40, finalY, 260, finalY);
    doc.setFont("helvetica", "bold");
    doc.text("Capacitación Collahuasi", 40, finalY + 20);

    // Fecha
    const fecha = new Date().toLocaleDateString("es-CL");
    doc.text(`Emitido el ${fecha}`, 40, finalY + 50);

    // Descargar
    doc.save(`Certificado_${trabajadorNombre}.pdf`);
}

// Cargar imágenes
function loadImage(url) {
    return new Promise(resolve => {
        const img = new Image();
        img.crossOrigin = "Anonymous";
        img.onload = () => resolve(img);
        img.src = url;
    });
}

    </script>
</body>
</html>

























