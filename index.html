<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Certificaciones Collahuasi — Consulta por RUT</title>

  <!-- Estilos -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

  <!-- Utilidades -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/es.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>

  <!-- PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --c1:#275317; --c2:#3b7d23; --c3:#8ed973; --cWarn:#de990e;
    }
    body{ background:#f6f7f9; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial; }
    .header{ background:var(--c1); color:#fff; padding:2rem 0 1.25rem; }
    .logo{ display:block; margin:0 auto 1rem; max-width:320px; width:100%; border-radius:20px; }
    .pill{ background:#eaf1ea; color:#225a16; border-radius:999px; padding:.45rem .8rem; display:inline-flex; gap:.5rem; align-items:center; font-weight:600; }
    .search-box{ background:#fff; border:1px solid #e8e8e8; border-radius:14px; padding:1.25rem; box-shadow:0 2px 8px rgba(0,0,0,.06); }
    .kpi{ color:#fff; border-radius:999px; padding:.35rem .75rem; font-weight:700; font-size:.95rem; }
    .kpi.v{ background:#1f8a46; } .kpi.x{ background:#c98208; }
    .card-cert{ background:#fff; border-left:4px solid; border-left-color:#ddd; border-radius:12px; padding:1rem; box-shadow:0 2px 8px rgba(0,0,0,.06); height:100%; }
    .card-cert.vigente{ border-left-color:#39b46c; }
    .card-cert.vencido{ border-left-color:#f3b343; }
    .badge-v{ background:#dbf1e5; color:#1b6b3f; } .badge-x{ background:#fff2cf; color:#8a6509; }
    .empty{ text-align:center; padding:3rem 1rem; color:#6b7280; }
    .btn-informe{ background:#1e3a1a; border:none; color:#fff; }
    .btn-informe:hover{ opacity:.9; color:#fff; }
    .btn-download{ background:var(--c2); color:#fff; border:none; padding:.45rem .8rem; border-radius:8px; font-size:.875rem; }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="header">
    <div class="container position-relative">
      <img class="logo" src="https://raw.githubusercontent.com/gocasesorias-arch/CollahuasiCap/main/LOGO2.0.png" alt="Collahuasi" />
      <div class="d-flex align-items-center gap-3 flex-wrap">
        <i class="fa-solid fa-hard-hat" style="font-size:2rem;color:var(--cWarn)"></i>
        <div class="me-auto">
          <h1 class="h3 mb-1">Certificaciones Collahuasi</h1>
          <div class="text-white-50 small">Sistema de Consulta de Certificaciones</div>
        </div>
        <!-- Enlace directo al dashboard -->
        <a href="informe.html" class="btn btn-sm btn-informe">
          <i class="fa-solid fa-chart-line me-1"></i> Informe
        </a>
        <div id="status" class="ms-2"></div>
      </div>

      <!-- barra de búsqueda -->
      <div id="searchBox" class="search-box mt-3" style="display:none">
        <div class="row g-2">
          <div class="col-md-10">
            <input id="rut" class="form-control form-control-lg" placeholder="Ingrese RUT (Ej: 12.345.678-9)" maxlength="12" autocomplete="off" />
          </div>
          <div class="col-md-2 d-grid">
            <button id="btnBuscar" class="btn btn-lg" style="background:var(--c2);color:#fff">
              <i class="fa-solid fa-magnifying-glass me-1"></i> Buscar
            </button>
          </div>
        </div>
        <div class="form-text mt-2">Se valida dígito verificador y formato automáticamente.</div>
      </div>

      <!-- mensaje inicial -->
      <div id="noDataMsg" class="search-box mt-3 text-center">
        <i class="fa-solid fa-circle-exclamation" style="font-size:2.2rem;color:var(--cWarn)"></i>
        <p class="mt-2 mb-1 fw-semibold text-dark">Sistema sin datos cargados</p>
        <p class="mb-0 text-secondary small">Espere unos segundos mientras se cargan los datos automáticamente</p>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="container my-4">
    <div id="kpis" class="d-flex flex-wrap gap-2 mb-3"></div>

    <!-- Exportar PDF: oculto hasta que existan resultados -->
    <div id="exportBox" class="d-flex justify-content-end mb-3" style="display:none">
      <button id="btnPDF" class="btn" style="background:#de990e;color:#fff">
        <i class="fa-solid fa-file-pdf me-1"></i> Exportar PDF
      </button>
    </div>

    <div id="loading" class="text-center text-secondary" style="display:none">
      <div class="spinner-border text-success" role="status" aria-label="Cargando"></div>
      <div class="small mt-2">Buscando certificaciones…</div>
    </div>

    <div id="results" class="row g-3"></div>

    <div id="empty" class="empty" style="display:none">
      <i class="fa-solid fa-magnifying-glass" style="font-size:3rem"></i>
      <h3 class="h5 mt-3">Busque certificaciones por RUT</h3>
      <p>Ingrese el RUT del trabajador para ver sus certificaciones</p>
    </div>
  </main>

  <!-- Modal de guía -->
  <div class="modal fade" id="guideModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header" style="background:var(--c1);color:#fff">
          <h5 class="modal-title">Guía de descarga</h5>
          <button class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body" id="guideBody"></div>
        <div class="modal-footer">
          <a id="guideLink" href="#" target="_blank" class="btn" style="background:var(--c2);color:#fff">
            <i class="fa-solid fa-up-right-from-square me-1"></i> Ir al Portal
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    dayjs.locale('es'); dayjs.extend(window.dayjs_plugin_customParseFormat);

    // -------- CONFIG Y FALLBACKS 429 --------
    const RAW = "https://raw.githubusercontent.com/gocasesorias-arch/CollahuasiCap/main/tableConvert.com_jt1fa1.json";
    const CDN = "https://cdn.jsdelivr.net/gh/gocasesorias-arch/CollahuasiCap@main/tableConvert.com_jt1fa1.json";
    const LOCAL = "data/tableConvert.com_jt1fa1.json"; // súbelo si quieres fallback local
    const dataSources = [
      () => fetch(CDN, {cache:"no-store"}),
      () => fetch(RAW + "?v=" + Date.now(), {cache:"no-store"}),
      () => fetch(LOCAL, {cache:"no-store"}),
    ];
    const CACHE_KEY = "colla_cert_data_v1";
    const CACHE_MS  = 24*60*60*1000;

    // -------- ESTADO UI --------
    const $status = document.getElementById("status");
    const $search = document.getElementById("searchBox");
    const $noData = document.getElementById("noDataMsg");
    const $kpis   = document.getElementById("kpis");
    const $results= document.getElementById("results");
    const $loading= document.getElementById("loading");
    const $empty  = document.getElementById("empty");
    const $export = document.getElementById("exportBox");
    const $rut    = document.getElementById("rut");

    let ALL = [];
    let lastRows = [];
    let lastRut = "";
    let lastWorker = {trabajador:"-", posicion:"-"};

    function setLoadingBadge(){
      $status.innerHTML = `<span class="pill" style="background:#fff3cd;color:#7a5a00">
        <i class="fa-solid fa-circle-exclamation"></i> Cargando datos…
      </span>`;
      $search.style.display="none"; $noData.style.display="block";
    }
    function setReadyBadge(total){
      $status.innerHTML = `<span class="pill">
        <i class="fa-solid fa-circle-check"></i> Sistema Activo
      </span><div class="text-white-50 small mt-1 text-end">${total} registros</div>`;
      $search.style.display="block"; $noData.style.display="none"; $empty.style.display="block";
    }
    function setErrorBadge(){
      $status.innerHTML = `<span class="pill" style="background:#f8d7da;color:#7f1d1d">
        <i class="fa-solid fa-circle-xmark"></i> Error cargando datos
      </span>`;
      $search.style.display="none"; $noData.style.display="block";
    }

    // -------- CARGA CON CACHE + FALLBACK --------
    async function loadData(){
      setLoadingBadge();
      // cache
      try{
        const cached = JSON.parse(localStorage.getItem(CACHE_KEY) || "null");
        if (cached && (Date.now() - cached.t) < CACHE_MS && Array.isArray(cached.data)){
          ALL = cached.data;
          setReadyBadge(ALL.length);
          return;
        }
      }catch(_) {}

      // intentos en cadena
      let ok = false, json = null, error = null;
      for (const tryFetch of dataSources){
        try{
          const r = await tryFetch();
          if (!r.ok) { error = new Error("HTTP "+r.status); continue; }
          json = await r.json();
          if (!Array.isArray(json)) throw new Error("Formato JSON inválido");
          ok = true; break;
        }catch(e){ error = e; }
      }
      if (!ok){ console.error("Falló carga:", error); setErrorBadge(); return; }

      ALL = json;
      try{ localStorage.setItem(CACHE_KEY, JSON.stringify({t:Date.now(), data:ALL})); }catch(_){}
      setReadyBadge(ALL.length);
    }

    // -------- UTILIDADES --------
    function fmtRut(x){
      const clean = (x||"").replace(/[^0-9kK]/g,"");
      if (!clean) return "";
      const dv = clean.slice(-1).toUpperCase();
      const body = clean.slice(0,-1);
      return body.replace(/\B(?=(\d{3})+(?!\d))/g,".") + "-" + dv;
    }
    function dvCalc(n){
      let M=0,S=1; for(;n;n=Math.floor(n/10)) S=(S+(n%10)*(9-(M++%6)))%11;
      return S? String(S-1) : "K";
    }
    function rutValid(rut){
      const raw = (rut||"").replace(/\.|-/g,"").toUpperCase();
      if (raw.length<2) return false;
      const body = raw.slice(0,-1), dv = raw.slice(-1);
      if (!/^\d+$/.test(body)) return false;
      return dvCalc(parseInt(body,10))===dv;
    }
    function nrmRut(x){ return (x||"").replace(/\.|-/g,"").toUpperCase().trim(); }
    function g(obj,...keys){ for(const k of keys){ if (obj?.[k]!=null) return obj[k]; if (obj?.[k?.toLowerCase?.()]!=null) return obj[k.toLowerCase()]; } }
    function pDate(v){
      if(!v) return null;
      const fmts=['DD/MM/YYYY','D/M/YYYY','YYYY-MM-DD','DD-MM-YYYY','D-MM-YYYY','YYYY/MM/DD'];
      for(const f of fmts){ const d=dayjs(v,f,true); if(d.isValid()) return d; }
      const d2=dayjs(v); return d2.isValid()? d2 : null;
    }
    function fDate(d){ return d? d.format('DD-MM-YYYY') : '—'; }

    function categorizar(nombre){
      const n = String(nombre||"").toUpperCase();
      const MOV = ["GRÚAS MÓVILES TIPO AT","OPERAR CAMIÓN PLUMA","OPERAR GRÚA","PUENTE GRÚA","RETROEXCAVADORA","RIGGER"];
      const EPF = ["EPF#5","EPF#6","TÉCNICAS Y MANIOBRAS DE IZAJE"];
      if (MOV.some(s => n.includes(s))) return "equiposMoviles";
      if (EPF.some(s => n.includes(s))) return "epf";
      return "otros";
    }

    // -------- RENDER --------
    function showKPIs(rows){
      if (!rows.length){ $kpis.innerHTML=""; $export.style.display="none"; return; }
      const vig = rows.filter(r=>r.vigente).length;
      const ven = rows.length - vig;
      $kpis.innerHTML = `
        <span class="kpi v"><i class="fa-solid fa-circle-check me-1"></i>Vigentes: ${vig}</span>
        <span class="kpi x"><i class="fa-solid fa-triangle-exclamation me-1"></i>Vencidos: ${ven}</span>`;
      $export.style.display = rows.length ? "flex" : "none";
    }

    function certCard(c){
      return `
        <div class="col-md-4">
          <div class="card-cert ${c.vigente ? 'vigente':'vencido'}">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <h6 class="mb-0 pe-2">${c.nombre}</h6>
              <i class="fa-solid ${c.vigente ? 'fa-circle-check text-success':'fa-circle-exclamation text-warning'}"></i>
            </div>
            <div class="small text-secondary mb-2">
              <div><strong>Inicio:</strong> ${fDate(c.fi)}</div>
              <div><strong>Vencimiento:</strong> ${fDate(c.ft)}</div>
              <div><strong>OTEC:</strong> ${c.otec}</div>
            </div>
            <div class="d-flex justify-content-between align-items-center">
              <span class="badge ${c.vigente?'badge-v':'badge-x'}">${c.vigente?'VIGENTE':'VENCIDO'}</span>
              <button class="btn-download" onclick="showGuide('${c.cat}')">
                <i class="fa-solid fa-download me-1"></i> Descargar
              </button>
            </div>
          </div>
        </div>`;
    }

    function renderResults(rows){
      if (!rows.length){
        $results.innerHTML = `
          <div class="empty">
            <i class="fa-solid fa-circle-xmark" style="font-size:3rem"></i>
            <h3 class="h5 mt-3">No se encontraron certificaciones</h3>
            <p class="mb-0">Verifique el RUT ingresado</p>
          </div>`;
        $export.style.display="none"; return;
      }

      // bloque datos del trabajador
      const head = `
        <div class="col-12">
          <div class="card-cert">
            <h5 style="color:var(--c1)">Datos del Trabajador</h5>
            <div class="row">
              <div class="col-md-6"><strong>Nombre:</strong> ${lastWorker.trabajador}</div>
              <div class="col-md-6"><strong>Posición:</strong> ${lastWorker.posicion}</div>
            </div>
          </div>
        </div>`;

      const groups = {equiposMoviles:[], epf:[], otros:[]};
      rows.forEach(r => groups[r.cat].push(r));

      const section = (title, color, arr) => !arr.length ? "" : `
        <div class="col-12 mt-3">
          <div class="d-flex align-items-center gap-2 mb-2">
            <div style="width:4px;height:24px;background:${color};border-radius:2px"></div>
            <h5 class="mb-0" style="color:var(--c1)">${title}</h5>
            <span class="badge" style="background:#f3f4f6;color:#374151">${arr.length}</span>
          </div>
          <div class="row g-3">${arr.map(certCard).join("")}</div>
        </div>`;

      $results.innerHTML =
        head +
        section("Equipos Móviles","var(--c2)", groups.equiposMoviles) +
        section("Estándares de Prevención de Fatalidades (EPF)","var(--cWarn)", groups.epf) +
        section("Otras Certificaciones","var(--c2)", groups.otros);
    }

    // -------- BUSCAR --------
    function search(){
      // al iniciar búsqueda oculto el PDF
      $export.style.display="none";

      const val = $rut.value;
      if (val.length < 9) return;
      if (!rutValid(val)){
        $results.innerHTML = `
          <div class="empty">
            <i class="fa-solid fa-id-card-clip" style="font-size:3rem"></i>
            <h3 class="h5 mt-3">RUT inválido</h3>
            <p class="mb-0">Revise el formato y dígito verificador. Ej: 12.345.678-9</p>
          </div>`;
        $kpis.innerHTML=""; return;
      }

      $loading.style.display="block"; $results.innerHTML=""; $empty.style.display="none";
      setTimeout(() => {
        const clean = nrmRut(val);
        const items = ALL.filter(it => nrmRut(String(g(it,"RUT","rut"))) === clean);
        $loading.style.display="none";

        if (!items.length){
          renderResults([]); showKPIs([]); return;
        }

        lastWorker = {
          trabajador: g(items[0],"Trabajador","trabajador") || "—",
          posicion:   g(items[0],"Posición","Posicion","posicion") || "—"
        };

        const norm = items.map(it => {
          const fi = pDate(g(it,"Fecha Inicio Vigencia","fecha_inicio_vigencia"));
          const ft = pDate(g(it,"Fecha Termino Vigencia","fecha_termino_vigencia"));
          return {
            nombre: g(it,"Certificado","certificado") || "—",
            fi, ft,
            vigente: ft ? ft.endOf("day").isAfter(dayjs()) : false,
            otec: g(it,"Otec","otec") || "—",
            cat:  categorizar(g(it,"Certificado","certificado"))
          };
        }).sort((a,b) => {
          const A = a.ft? a.ft.valueOf() : Infinity;
          const B = b.ft? b.ft.valueOf() : Infinity;
          return A - B;
        });

        lastRows = norm; lastRut = fmtRut(clean);
        showKPIs(norm);
        renderResults(norm);
      }, 250);
    }

    // -------- GUÍA MODAL --------
    function showGuide(cat){
      const guides = {
        equiposMoviles:{
          link:"https://participantes.ceim.cl/index.asp",
          steps:[
            "Ingrese al portal CEIM",
            "Inicie sesión con sus credenciales",
            "Abra 'Mis Certificaciones'",
            "Busque su certificación de equipos móviles",
            "Presione 'Descargar'"
          ]
        },
        epf:{
          link:"https://certificate.fsmspa.com/",
          steps:[
            "Acceda al portal FSM",
            "Ingrese su RUT",
            "Seleccione la certificación EPF",
            "Verifique vigencia",
            "Presione 'Descargar Certificado'"
          ]
        },
        otros:{
          link:"https://participantes.ceim.cl/index.asp",
          steps:[
            "Ingrese al portal",
            "Inicie sesión",
            "Busque la certificación disponible",
            "Descargue el PDF"
          ]
        }
      };
      const guide = guides[cat] || guides.otros;
      const body = guide.steps.map((s,i)=>`
        <div class="d-flex gap-3 mb-2">
          <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center" style="width:28px;height:28px">${i+1}</div>
          <div>${s}</div>
        </div>`).join("") + `
        <div class="alert alert-info mt-3"><strong>Nota:</strong> Si tiene problemas, contacte al área de capacitación.</div>`;
      document.getElementById("guideBody").innerHTML = body;
      document.getElementById("guideLink").href = guide.link;
      new bootstrap.Modal(document.getElementById("guideModal")).show();
    }
    window.showGuide = showGuide; // para el onclick

    // -------- PDF --------
    function exportPDF(){
      if (!lastRows.length) return;
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({unit:"pt", format:"a4"});
      let y = 40, mx = 40;

      doc.setFontSize(14);
      doc.text("Certificaciones Collahuasi - Informe", mx, y); y+=18;
      doc.setFontSize(10);
      doc.text(`RUT: ${lastRut||"-"}`, mx, y); y+=14;
      doc.text(`Trabajador: ${lastWorker.trabajador||"-"}`, mx, y); y+=14;
      doc.text(`Posición: ${lastWorker.posicion||"-"}`, mx, y); y+=18;

      const rows = lastRows.map(c => [
        c.nombre,
        c.fi ? c.fi.format("DD-MM-YYYY") : "—",
        c.ft ? c.ft.format("DD-MM-YYYY") : "—",
        c.vigente ? "Vigente" : "Vencido",
        c.otec,
        c.cat
      ]);

      doc.autoTable({
        startY:y,
        head:[["Certificado","Inicio","Vencimiento","Estado","OTEC","Categoría"]],
        body:rows,
        styles:{fontSize:8, cellPadding:4},
        headStyles:{fillColor:[39,83,23], textColor:255},
        alternateRowStyles:{fillColor:[246,247,249]},
        margin:{left:mx, right:mx}
      });

      const dateStr = new Date().toISOString().slice(0,10);
      const nameSafe = (lastWorker.trabajador||"trabajador").replace(/[^a-zA-Z0-9-_]+/g,"_");
      doc.save(`certificaciones_${nameSafe}_${dateStr}.pdf`);
    }

    // -------- BINDINGS --------
    document.getElementById("btnBuscar").addEventListener("click", search);
    document.getElementById("btnPDF").addEventListener("click", exportPDF);
    // formateo en vivo
    $rut.addEventListener("input", (e) => {
      const pos = e.target.selectionStart;
      e.target.value = fmtRut(e.target.value);
      e.target.selectionStart = e.target.selectionEnd = pos;
    });
    $rut.addEventListener("keypress", (e) => { if (e.key === "Enter") search(); });

    // -------- INIT --------
    (async function(){
      await loadData();
      // siempre oculto PDF al iniciar
      $export.style.display = "none";
    })();
  </script>
</body>
</html>










