<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Informe de Certificaciones</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Íconos Lucide -->
  <script src="https://unpkg.com/lucide@latest" crossorigin="anonymous"></script>

  <!-- Librerías VENDORIZADAS (orden obligatorio) -->
  <script src="vendor/react.min.js"></script>
  <script src="vendor/react-dom.min.js"></script>
  <script src="vendor/prop-types.min.js"></script>
  <script src="vendor/recharts.min.js"></script>

  <!-- Babel — solo para desarrollo local -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    .spin { animation: spin 1s linear infinite }
    @keyframes spin { from {transform:rotate(0)} to {transform:rotate(360deg)} }
  </style>
</head>

<body class="bg-gray-50">
  <div id="root"></div>

  <!-- React App -->
  <script type="text/babel" data-presets="env,react">

    const {useState, useMemo, useEffect} = React;
    const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts;

    // ✅ Cargar JSON local
    const DATA_URL = "tableConvert.com_jt1fa1.json";

    const CERTS_WHITELIST = new Set([
      "AISLAMIENTO, BLOQUEO Y PRUEBAS DE ENERGÍA EPF#5",
      "CamiÓn de Transmisión Mack",
      "Camión Friegthliner M2 112/ Transmisión Automática Allison",
      "Camión Internacional 7600 / Transmisión Automática Allison",
      "Camión Mercedes Benz AXOR 3131/ Transmisión ZF Secuencial",
      "Camión Renault C-440 / Caja Automática OPTDRIVER",
      "Camiones Mercedes Benz, Arocs 3236 B - Transmisión Powershift 3",
      "Camiones Mercedes Benz, Arocs 3236 B - Transmisión Telligent",
      "CERTIFICACIÓN PROTECCIÓN RADIOLÓGICA",
      "Grúas móviles tipo AT",
      "NFPA 70 E - SEGURIDAD ELECTRICA",
      "Operación Caldera",
      "Operador mantenedor",
      "Operador Rigger",
      "OPERAR CAMIÓN PLUMA",
      "OPERAR GRÚA ALZAHOMBRE",
      "OPERAR GRÚA HORQUILLA",
      "OPERAR GRÚA PEDESTAL",
      "OPERAR GRÚA PLUMA",
      "OPERAR PUENTE GRÚA",
      "OPERAR RETROEXCAVADORA",
      "PROTECCIÓN CONTRA CAÍDAS EPF#6",
      "PROTECCIONES RADIOLÓGICAS",
      "Seguridad Eléctrica en Lugares de Trabajo - NFPA 70E",
      "Señalero",
      "Señalero Calificado",
      "TÉCNICAS Y MANIOBRAS DE IZAJE Y LEVANTE (RIGGER)"
    ].map(s => s.toUpperCase()));

    const norm = v => (v ?? '').toString().trim();
    const normU = v => norm(v).toUpperCase();
    const normL = v => norm(v).toLowerCase();
    const getAny = (o, ks) => { for (const k of ks) if (o?.[k] != null) return o[k]; };

    const groupCount = (rows, keyFn, whereFn = () => true) => {
      const m = new Map();
      for (const r of rows) if (whereFn(r)) {
        const k = keyFn(r) ?? '—';
        m.set(k, (m.get(k) || 0) + 1);
      }
      return Array.from(m, ([name, value]) => ({ name, value }));
    };
    const groupPct = (rows, keyFn, predFn) => {
      const total = new Map(), hit = new Map();
      for (const r of rows) {
        const k = keyFn(r) ?? '—';
        total.set(k, (total.get(k)||0)+1);
        if (predFn(r)) hit.set(k, (hit.get(k)||0)+1);
      }
      return Array.from(total, ([name, t]) => {
        const h = hit.get(name)||0;
        return { name, pct: t ? +(h*100/t).toFixed(1) : 0 };
      });
    };

    function Informe() {

      const [raw, setRaw] = useState(null);
      const [error, setError] = useState('');

      const [vpFiltro, setVpFiltro] = useState('todas');
      const [gerenciaFiltro, setGerenciaFiltro] = useState('todas');
      const [supFiltro, setSupFiltro] = useState('todas');

      useEffect(() => {
        (async () => {
          try {
            const res = await fetch(DATA_URL);
            if (!res.ok) throw new Error('Error cargando JSON local');
            const data = await res.json();
            setRaw(Array.isArray(data) ? data : []);
          } catch(e) {
            console.error(e);
            setError(e.message);
          }
        })();
      }, []);

      const canon = useMemo(() => (raw||[]).map(r => ({
        certificado: normU(getAny(r, ['Certificado','certificado','Nombre','nombre'])),
        estado:      normL(getAny(r, ['estado','Estado'])),
        vp:          norm(getAny(r, ['Vicepresidencia','vicepresidencia','VP','vp'])),
        ger:         norm(getAny(r, ['Gerencia','gerencia'])),
        sup:         norm(getAny(r, ['Superintendencia','superintendencia','Super','super'])),
      })), [raw]);

      const universe = useMemo(() => canon.filter(r =>
        CERTS_WHITELIST.has(r.certificado)
      ), [canon]);

      const vps  = [...new Set(universe.map(r=>r.vp).filter(Boolean))];
      const gers = [...new Set(universe.map(r=>r.ger).filter(Boolean))];
      const sups = [...new Set(universe.map(r=>r.sup).filter(Boolean))];

      const filtered = useMemo(() => universe.filter(r =>
        (vpFiltro==='todas' || r.vp===vpFiltro) &&
        (gerenciaFiltro==='todas' || r.ger===gerenciaFiltro) &&
        (supFiltro==='todas' || r.sup===supFiltro)
      ), [universe, vpFiltro, gerenciaFiltro, supFiltro]);

      const kpi = useMemo(() => {
        const total = filtered.length;
        const vig = filtered.filter(r=>r.estado==='vigente').length;
        const ven = filtered.filter(r=>r.estado==='vencido').length;
        const base = Math.max(1, vig+ven);
        return { total, vig, ven, pctVig:+(vig*100/base).toFixed(1), pctVen:+(ven*100/base).toFixed(1) };
      }, [filtered]);

      const dataVpStack =
        Object.values(filtered.reduce((acc, r)=>{
          if(!acc[r.vp]) acc[r.vp]={name:r.vp, Vigentes:0, Vencidos:0};
          if(r.estado==='vigente') acc[r.vp].Vigentes++;
          else acc[r.vp].Vencidos++;
          return acc;
        },{}));

      if(error){
        return (
          <div class="flex justify-center items-center h-screen">
            <div class="bg-red-200 text-red-800 px-6 py-3 rounded-lg text-lg">
              ❌ {error}
            </div>
          </div>
        );
      }

      if(!raw){
        return (
          <div class="flex justify-center items-center h-screen text-gray-600">
            <i data-lucide="loader-2" class="w-6 h-6 mr-2 spin"></i>
            Cargando datos...
          </div>
        );
      }

      return (
        <div class="max-w-7xl mx-auto p-6">
          <h1 class="text-3xl font-bold mb-8">Informe de Certificaciones</h1>

          {/* CARD KPIs */}
          <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-8">
            <div class="bg-white shadow rounded p-5">Total: {kpi.total}</div>
            <div class="bg-white shadow rounded p-5">Vigentes: {kpi.vig} ({kpi.pctVig}%)</div>
            <div class="bg-white shadow rounded p-5">Vencidas: {kpi.ven} ({kpi.pctVen}%)</div>
            <div class="bg-white shadow rounded p-5">Filtros: {(vpFiltro!=='todas')+(gerenciaFiltro!=='todas')+(supFiltro!=='todas')}</div>
          </div>

          {/* GRÁFICO BASE */}
          <div class="bg-white shadow rounded p-5">
            <h2 class="font-semibold mb-3">Vigentes vs Vencidos por VP</h2>

            <ResponsiveContainer width="100%" height={300}>
              <BarChart data={dataVpStack}>
                <CartesianGrid strokeDasharray="3 3"/>
                <XAxis dataKey="name"/>
                <YAxis/>
                <Tooltip/>
                <Legend/>
                <Bar dataKey="Vigentes" fill="#10B981"/>
                <Bar dataKey="Vencidos" fill="#EF4444"/>
              </BarChart>
            </ResponsiveContainer>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<Informe/>);
  </script>
</body>
</html>
