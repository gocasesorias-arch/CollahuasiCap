<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Informe de Certificaciones</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide (íconos) -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- React + ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel para JSX en el navegador -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Recharts -->
  <script src="https://unpkg.com/recharts@2.5.0/dist/Recharts.js"></script>

  <style>
    .spin { animation: spin 1s linear infinite }
    @keyframes spin { from {transform:rotate(0)} to {transform:rotate(360deg)} }
  </style>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <!-- IMPORTANTE: usar presets env,react -->
  <script type="text/babel" data-presets="env,react">
    const {useState, useMemo, useEffect} = React;
    const {
      BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer
    } = Recharts;

    /* ========= Config ========= */
    const DATA_URL = "https://raw.githubusercontent.com/gocasesorias-arch/CollahuasiCap/main/tableConvert.com_jt1fa1.json";

    const CERTS_WHITELIST = new Set([
      "AISLAMIENTO, BLOQUEO Y PRUEBAS DE ENERGÍA EPF#5",
      "Camión de Transmisión Mack",
      "Camión Friegthliner M2 112/ Transmisión Automática Allison",
      "Camión Internacional 7600 / Transmisión Automática Allison",
      "Camión Mercedes Benz AXOR 3131/ Transmisión ZF Secuencial",
      "Camión Renault C-440 / Caja Automática OPTDRIVER",
      "Camiones Mercedes Benz, Arocs 3236 B - Transmisión Powershift 3",
      "Camiones Mercedes Benz, Arocs 3236 B - Transmisión Telligent",
      "CERTIFICACIÓN PROTECCIÓN RADIOLÓGICA",
      "Grúas móviles tipo AT",
      "NFPA 70 E - SEGURIDAD ELECTRICA",
      "Operación Caldera",
      "Operador mantenedor",
      "Operador Rigger",
      "OPERAR CAMIÓN PLUMA",
      "OPERAR GRÚA ALZAHOMBRE",
      "OPERAR GRÚA HORQUILLA",
      "OPERAR GRÚA PEDESTAL",
      "OPERAR GRÚA PLUMA",
      "OPERAR PUENTE GRÚA",
      "OPERAR RETROEXCAVADORA",
      "PROTECCIÓN CONTRA CAÍDAS EPF#6",
      "PROTECCIONES RADIOLÓGICAS",
      "Seguridad Eléctrica en Lugares de Trabajo - NFPA 70E",
      "Señalero",
      "Señalero Calificado",
      "TÉCNICAS Y MANIOBRAS DE IZAJE Y LEVANTE (RIGGER)"
    ].map(s => s.toUpperCase()));

    const norm = v => (v ?? '').toString().trim();
    const normU = v => norm(v).toUpperCase();
    const normL = v => norm(v).toLowerCase();
    const getAny = (obj, keys) => { for (const k of keys) if (obj?.[k] != null) return obj[k]; };

    const groupCount = (rows, keyFn, whereFn = () => true) => {
      const map = new Map();
      for (const r of rows) if (whereFn(r)) {
        const k = keyFn(r) ?? '—';
        map.set(k, (map.get(k) || 0) + 1);
      }
      return Array.from(map, ([name, value]) => ({ name, value }));
    };
    const groupPct = (rows, keyFn, predFn) => {
      const total = new Map(), hit = new Map();
      for (const r of rows) {
        const k = keyFn(r) ?? '—';
        total.set(k, (total.get(k)||0)+1);
        if (predFn(r)) hit.set(k, (hit.get(k)||0)+1);
      }
      return Array.from(total, ([name, t]) => {
        const h = hit.get(name)||0;
        return { name, pct: t ? +(h*100/t).toFixed(1) : 0 };
      });
    };

    function Informe() {
      const [raw, setRaw] = useState(null);
      const [error, setError] = useState('');
      const [vpFiltro, setVpFiltro] = useState('todas');
      const [gerenciaFiltro, setGerenciaFiltro] = useState('todas');
      const [supFiltro, setSupFiltro] = useState('todas');

      // Auto-carga
      useEffect(() => {
        (async () => {
          try {
            const res = await fetch(DATA_URL, {cache:'no-store'});
            if (!res.ok) throw new Error('No se pudo descargar el JSON');
            const data = await res.json();
            setRaw(Array.isArray(data) ? data : []);
          } catch (e) {
            setError(e.message || 'Error cargando datos');
          }
        })();
      }, []);

      // Lucide
      useEffect(()=>{ if (window.lucide) lucide.createIcons({attrs:{'stroke-width':2}}); });

      // Canonización
      const canon = useMemo(() => (raw||[]).map(r => ({
        certificado: normU(getAny(r, ['Certificado','certificado','Nombre','nombre'])),
        estado:      normL(getAny(r, ['estado','Estado'])),
        vp:          norm(getAny(r, ['Vicepresidencia','vicepresidencia','VP','vp'])),
        ger:         norm(getAny(r, ['Gerencia','gerencia'])),
        sup:         norm(getAny(r, ['Superintendencia','superintendencia','Super','super'])),
      })), [raw]);

      // Universo válido
      const universe = useMemo(() => canon.filter(r =>
        CERTS_WHITELIST.has(r.certificado) &&
        (r.estado === 'vigente' || r.estado === 'vencido')
      ), [canon]);

      // Filtros dinámicos
      const vps  = useMemo(() => Array.from(new Set(universe.map(r=>r.vp).filter(Boolean))), [universe]);
      const gers = useMemo(() => Array.from(new Set(universe.map(r=>r.ger).filter(Boolean))), [universe]);
      const sups = useMemo(() => Array.from(new Set(universe.map(r=>r.sup).filter(Boolean))), [universe]);

      const filtered = useMemo(() => universe.filter(r =>
        (vpFiltro==='todas' || r.vp===vpFiltro) &&
        (gerenciaFiltro==='todas' || r.ger===gerenciaFiltro) &&
        (supFiltro==='todas' || r.sup===supFiltro)
