<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Informe de Certificaciones</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- √çconos Lucide -->
  <script src="https://unpkg.com/lucide@latest" crossorigin="anonymous"></script>

  <!-- Librer√≠as VENDORIZADAS (orden obligatorio) -->
  <script src="vendor/react.min.js"></script>
  <script src="vendor/react-dom.min.js"></script>
  <script src="vendor/prop-types.min.js"></script>
  <script src="vendor/recharts.min.js"></script>

  <!-- Babel ‚Äî solo para desarrollo local -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    /* Fix para advertencia de text-size-adjust */
    :host,
    html {
      text-size-adjust: 100%;
      -webkit-text-size-adjust: 100%;
    }

    .spin { animation: spin 1s linear infinite }
    @keyframes spin { from {transform:rotate(0)} to {transform:rotate(360deg)} }
  </style>
</head>

<body class="bg-gray-50">
  <!-- Preloader mientras carga React y Babel -->
  <div id="preloader" class="fixed inset-0 bg-gray-50 flex flex-col justify-center items-center z-50">
    <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-500 mb-4"></div>
    <div class="text-xl font-semibold text-gray-700 mb-2">Iniciando aplicaci√≥n...</div>
    <div class="text-sm text-gray-500">Compilando componentes y cargando datos</div>
  </div>

  <div id="root"></div>

  <!-- React App -->
  <script type="text/babel" data-presets="env,react">

    const {useState, useMemo, useEffect} = React;
    const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts;

    // ‚úÖ Cargar JSON local
    const DATA_URL = "tableConvert.com_jt1fa1.json";

    const CERTS_WHITELIST = new Set([
      "AISLAMIENTO, BLOQUEO Y PRUEBAS DE ENERG√çA EPF#5",
      "Cami√ìn de Transmisi√≥n Mack",
      "Cami√≥n Friegthliner M2 112/ Transmisi√≥n Autom√°tica Allison",
      "Cami√≥n Internacional 7600 / Transmisi√≥n Autom√°tica Allison",
      "Cami√≥n Mercedes Benz AXOR 3131/ Transmisi√≥n ZF Secuencial",
      "Cami√≥n Renault C-440 / Caja Autom√°tica OPTDRIVER",
      "Camiones Mercedes Benz, Arocs 3236 B - Transmisi√≥n Powershift 3",
      "Camiones Mercedes Benz, Arocs 3236 B - Transmisi√≥n Telligent",
      "CERTIFICACI√ìN PROTECCI√ìN RADIOL√ìGICA",
      "Gr√∫as m√≥viles tipo AT",
      "NFPA 70 E - SEGURIDAD ELECTRICA",
      "Operaci√≥n Caldera",
      "Operador mantenedor",
      "Operador Rigger",
      "OPERAR CAMI√ìN PLUMA",
      "OPERAR GR√öA ALZAHOMBRE",
      "OPERAR GR√öA HORQUILLA",
      "OPERAR GR√öA PEDESTAL",
      "OPERAR GR√öA PLUMA",
      "OPERAR PUENTE GR√öA",
      "OPERAR RETROEXCAVADORA",
      "PROTECCI√ìN CONTRA CA√çDAS EPF#6",
      "PROTECCIONES RADIOL√ìGICAS",
      "Seguridad El√©ctrica en Lugares de Trabajo - NFPA 70E",
      "Se√±alero",
      "Se√±alero Calificado",
      "T√âCNICAS Y MANIOBRAS DE IZAJE Y LEVANTE (RIGGER)"
    ].map(s => s.toUpperCase()));

    const norm = v => (v ?? '').toString().trim();
    const normU = v => norm(v).toUpperCase();
    const normL = v => norm(v).toLowerCase();
    const getAny = (o, ks) => { for (const k of ks) if (o?.[k] != null) return o[k]; };

    const groupCount = (rows, keyFn, whereFn = () => true) => {
      const m = new Map();
      for (const r of rows) if (whereFn(r)) {
        const k = keyFn(r) ?? '‚Äî';
        m.set(k, (m.get(k) || 0) + 1);
      }
      return Array.from(m, ([name, value]) => ({ name, value }));
    };
    const groupPct = (rows, keyFn, predFn) => {
      const total = new Map(), hit = new Map();
      for (const r of rows) {
        const k = keyFn(r) ?? '‚Äî';
        total.set(k, (total.get(k)||0)+1);
        if (predFn(r)) hit.set(k, (hit.get(k)||0)+1);
      }
      return Array.from(total, ([name, t]) => {
        const h = hit.get(name)||0;
        return { name, pct: t ? +(h*100/t).toFixed(1) : 0 };
      });
    };

    function Informe() {

      const [raw, setRaw] = useState(null);
      const [error, setError] = useState('');

      const [vpFiltro, setVpFiltro] = useState('todas');
      const [gerenciaFiltro, setGerenciaFiltro] = useState('todas');
      const [supFiltro, setSupFiltro] = useState('todas');

      useEffect(() => {
        (async () => {
          try {
            const res = await fetch(DATA_URL);
            if (!res.ok) throw new Error('Error cargando JSON local');
            const data = await res.json();
            setRaw(Array.isArray(data) ? data : []);
          } catch(e) {
            console.error(e);
            setError(e.message);
          }
        })();
      }, []);

      // Inicializar iconos Lucide despu√©s de cada render
      useEffect(() => {
        if (window.lucide) {
          window.lucide.createIcons();
        }
      });

      const canon = useMemo(() => (raw||[]).map(r => ({
        certificado: normU(getAny(r, ['Certificado','certificado','Nombre','nombre'])),
        estado:      normL(getAny(r, ['estado','Estado'])),
        vp:          norm(getAny(r, ['Vicepresidencia','vicepresidencia','VP','vp'])),
        ger:         norm(getAny(r, ['Gerencia','gerencia'])),
        sup:         norm(getAny(r, ['Superintendencia','superintendencia','Super','super'])),
      })), [raw]);

      const universe = useMemo(() => canon.filter(r =>
        CERTS_WHITELIST.has(r.certificado)
      ), [canon]);

      const vps  = [...new Set(universe.map(r=>r.vp).filter(Boolean))];
      const gers = [...new Set(universe.map(r=>r.ger).filter(Boolean))];
      const sups = [...new Set(universe.map(r=>r.sup).filter(Boolean))];

      const filtered = useMemo(() => universe.filter(r =>
        (vpFiltro==='todas' || r.vp===vpFiltro) &&
        (gerenciaFiltro==='todas' || r.ger===gerenciaFiltro) &&
        (supFiltro==='todas' || r.sup===supFiltro)
      ), [universe, vpFiltro, gerenciaFiltro, supFiltro]);

      const kpi = useMemo(() => {
        const total = filtered.length;
        const vig = filtered.filter(r=>r.estado==='vigente').length;
        const ven = filtered.filter(r=>r.estado==='vencido').length;
        const base = Math.max(1, vig+ven);
        return { total, vig, ven, pctVig:+(vig*100/base).toFixed(1), pctVen:+(ven*100/base).toFixed(1) };
      }, [filtered]);

      const dataVpStack =
        Object.values(filtered.reduce((acc, r)=>{
          if(!acc[r.vp]) acc[r.vp]={name:r.vp, Vigentes:0, Vencidos:0};
          if(r.estado==='vigente') acc[r.vp].Vigentes++;
          else acc[r.vp].Vencidos++;
          return acc;
        },{}));

      if(error){
        return (
          <div className="flex justify-center items-center h-screen">
            <div className="bg-red-200 text-red-800 px-6 py-3 rounded-lg text-lg">
              ‚ùå {error}
            </div>
          </div>
        );
      }

      if(!raw){
        return (
          <div className="flex flex-col justify-center items-center h-screen text-gray-600">
            <i data-lucide="loader-2" className="w-12 h-12 mb-4 spin text-blue-500"></i>
            <div className="text-xl font-semibold mb-2">Cargando datos...</div>
            <div className="text-sm text-gray-500">Procesando certificaciones (esto puede tomar unos segundos)</div>
            <div className="mt-4 bg-blue-100 text-blue-800 px-4 py-2 rounded-lg text-sm">
              üí° Tip: El archivo contiene 5,000+ registros
            </div>
          </div>
        );
      }

      return (
        <div className="max-w-7xl mx-auto p-6">
          <h1 className="text-3xl font-bold mb-8">Informe de Certificaciones</h1>

          {/* FILTROS */}
          <div className="bg-white shadow rounded p-5 mb-6">
            <h2 className="font-semibold mb-4 text-lg">Filtros</h2>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Vicepresidencia</label>
                <select
                  value={vpFiltro}
                  onChange={(e) => setVpFiltro(e.target.value)}
                  className="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  <option value="todas">Todas</option>
                  {vps.sort().map(vp => <option key={vp} value={vp}>{vp}</option>)}
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Gerencia</label>
                <select
                  value={gerenciaFiltro}
                  onChange={(e) => setGerenciaFiltro(e.target.value)}
                  className="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  <option value="todas">Todas</option>
                  {gers.sort().map(g => <option key={g} value={g}>{g}</option>)}
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Superintendencia</label>
                <select
                  value={supFiltro}
                  onChange={(e) => setSupFiltro(e.target.value)}
                  className="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  <option value="todas">Todas</option>
                  {sups.sort().map(s => <option key={s} value={s}>{s}</option>)}
                </select>
              </div>

            </div>
            {(vpFiltro !== 'todas' || gerenciaFiltro !== 'todas' || supFiltro !== 'todas') && (
              <button
                onClick={() => { setVpFiltro('todas'); setGerenciaFiltro('todas'); setSupFiltro('todas'); }}
                className="mt-4 px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-sm font-medium"
              >
                Limpiar filtros
              </button>
            )}
          </div>

          {/* CARD KPIs */}
          <div className="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-8">
            <div className="bg-white shadow rounded p-5 border-l-4 border-blue-500">
              <div className="text-sm text-gray-600 mb-1">Total</div>
              <div className="text-3xl font-bold">{kpi.total}</div>
            </div>
            <div className="bg-white shadow rounded p-5 border-l-4 border-green-500">
              <div className="text-sm text-gray-600 mb-1">Vigentes</div>
              <div className="text-3xl font-bold text-green-600">{kpi.vig}</div>
              <div className="text-sm text-gray-500">{kpi.pctVig}%</div>
            </div>
            <div className="bg-white shadow rounded p-5 border-l-4 border-red-500">
              <div className="text-sm text-gray-600 mb-1">Vencidas</div>
              <div className="text-3xl font-bold text-red-600">{kpi.ven}</div>
              <div className="text-sm text-gray-500">{kpi.pctVen}%</div>
            </div>
            <div className="bg-white shadow rounded p-5 border-l-4 border-purple-500">
              <div className="text-sm text-gray-600 mb-1">Filtros Activos</div>
              <div className="text-3xl font-bold">
                {[vpFiltro !== 'todas', gerenciaFiltro !== 'todas', supFiltro !== 'todas'].filter(Boolean).length}
              </div>
            </div>
          </div>

          {/* GR√ÅFICO BASE */}
          {filtered.length === 0 ? (
            <div className="bg-yellow-50 border border-yellow-200 text-yellow-800 px-6 py-4 rounded-lg">
              ‚ö†Ô∏è No hay datos que mostrar con los filtros seleccionados.
            </div>
          ) : (
            <div className="bg-white shadow rounded p-5">
              <h2 className="font-semibold mb-3 text-lg">Vigentes vs Vencidos por VP</h2>

            <ResponsiveContainer width="100%" height={300}>
              <BarChart data={dataVpStack}>
                <CartesianGrid strokeDasharray="3 3"/>
                <XAxis dataKey="name"/>
                <YAxis/>
                <Tooltip/>
                <Legend/>
                <Bar dataKey="Vigentes" fill="#10B981"/>
                <Bar dataKey="Vencidos" fill="#EF4444"/>
              </BarChart>
            </ResponsiveContainer>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<Informe/>);

    // Ocultar preloader una vez que React se monta
    setTimeout(() => {
      const preloader = document.getElementById('preloader');
      if (preloader) {
        preloader.style.opacity = '0';
        preloader.style.transition = 'opacity 0.3s';
        setTimeout(() => preloader.remove(), 300);
      }
    }, 100);
  </script>
</body>
</html>
