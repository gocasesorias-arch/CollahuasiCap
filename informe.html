<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Informe de Certificaciones</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Íconos Lucide -->
  <script src="https://unpkg.com/lucide@latest" crossorigin="anonymous"></script>

  <!-- Librerías VENDORIZADAS (orden obligatorio) -->
  <script src="vendor/react.min.js"></script>
  <script src="vendor/react-dom.min.js"></script>
  <script src="vendor/prop-types.min.js"></script>
  <script src="vendor/recharts.min.js"></script>

  <!-- Babel — solo para desarrollo local -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    /* Fix para advertencia de text-size-adjust */
    :host,
    html {
      text-size-adjust: 100%;
      -webkit-text-size-adjust: 100%;
    }

    .spin { animation: spin 1s linear infinite }
    @keyframes spin { from {transform:rotate(0)} to {transform:rotate(360deg)} }
  </style>
</head>

<body class="bg-gray-50">
  <div id="root"></div>

  <!-- React App -->
  <script type="text/babel" data-presets="env,react">

    const {useState, useMemo, useEffect} = React;
    const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts;

    // ✅ Cargar JSON local
    const DATA_URL = "tableConvert.com_jt1fa1.json";

    const CERTS_WHITELIST = new Set([
      "AISLAMIENTO, BLOQUEO Y PRUEBAS DE ENERGÍA EPF#5",
      "CamiÓn de Transmisión Mack",
      "Camión Friegthliner M2 112/ Transmisión Automática Allison",
      "Camión Internacional 7600 / Transmisión Automática Allison",
      "Camión Mercedes Benz AXOR 3131/ Transmisión ZF Secuencial",
      "Camión Renault C-440 / Caja Automática OPTDRIVER",
      "Camiones Mercedes Benz, Arocs 3236 B - Transmisión Powershift 3",
      "Camiones Mercedes Benz, Arocs 3236 B - Transmisión Telligent",
      "CERTIFICACIÓN PROTECCIÓN RADIOLÓGICA",
      "Grúas móviles tipo AT",
      "NFPA 70 E - SEGURIDAD ELECTRICA",
      "Operación Caldera",
      "Operador mantenedor",
      "Operador Rigger",
      "OPERAR CAMIÓN PLUMA",
      "OPERAR GRÚA ALZAHOMBRE",
      "OPERAR GRÚA HORQUILLA",
      "OPERAR GRÚA PEDESTAL",
      "OPERAR GRÚA PLUMA",
      "OPERAR PUENTE GRÚA",
      "OPERAR RETROEXCAVADORA",
      "PROTECCIÓN CONTRA CAÍDAS EPF#6",
      "PROTECCIONES RADIOLÓGICAS",
      "Seguridad Eléctrica en Lugares de Trabajo - NFPA 70E",
      "Señalero",
      "Señalero Calificado",
      "TÉCNICAS Y MANIOBRAS DE IZAJE Y LEVANTE (RIGGER)"
    ].map(s => s.toUpperCase()));

    const norm = v => (v ?? '').toString().trim();
    const normU = v => norm(v).toUpperCase();
    const normL = v => norm(v).toLowerCase();
    const getAny = (o, ks) => { for (const k of ks) if (o?.[k] != null) return o[k]; };

    const groupCount = (rows, keyFn, whereFn = () => true) => {
      const m = new Map();
      for (const r of rows) if (whereFn(r)) {
        const k = keyFn(r) ?? '—';
        m.set(k, (m.get(k) || 0) + 1);
      }
      return Array.from(m, ([name, value]) => ({ name, value }));
    };
    const groupPct = (rows, keyFn, predFn) => {
      const total = new Map(), hit = new Map();
      for (const r of rows) {
        const k = keyFn(r) ?? '—';
        total.set(k, (total.get(k)||0)+1);
        if (predFn(r)) hit.set(k, (hit.get(k)||0)+1);
      }
      return Array.from(total, ([name, t]) => {
        const h = hit.get(name)||0;
        return { name, pct: t ? +(h*100/t).toFixed(1) : 0 };
      });
    };

    function Informe() {

      const [raw, setRaw] = useState(null);
      const [error, setError] = useState('');

      const [vpFiltro, setVpFiltro] = useState('todas');
      const [gerenciaFiltro, setGerenciaFiltro] = useState('todas');
      const [supFiltro, setSupFiltro] = useState('todas');

      useEffect(() => {
        (async () => {
          try {
            const res = await fetch(DATA_URL);
            if (!res.ok) throw new Error('Error cargando JSON local');
            const data = await res.json();
            setRaw(Array.isArray(data) ? data : []);
          } catch(e) {
            console.error(e);
            setError(e.message);
          }
        })();
      }, []);

      // Inicializar iconos Lucide después de cada render
      useEffect(() => {
        if (window.lucide) {
          window.lucide.createIcons();
        }
      });

      const canon = useMemo(() => (raw||[]).map(r => ({
        certificado: normU(getAny(r, ['Certificado','certificado','Nombre','nombre'])),
        estado:      normL(getAny(r, ['estado','Estado'])),
        vp:          norm(getAny(r, ['Vicepresidencia','vicepresidencia','VP','vp'])),
        ger:         norm(getAny(r, ['Gerencia','gerencia'])),
        sup:         norm(getAny(r, ['Superintendencia','superintendencia','Super','super'])),
      })), [raw]);

      const universe = useMemo(() => canon.filter(r =>
        CERTS_WHITELIST.has(r.certificado)
      ), [canon]);

      const vps  = [...new Set(universe.map(r=>r.vp).filter(Boolean))];
      const gers = [...new Set(universe.map(r=>r.ger).filter(Boolean))];
      const sups = [...new Set(universe.map(r=>r.sup).filter(Boolean))];

      const filtered = useMemo(() => universe.filter(r =>
        (vpFiltro==='todas' || r.vp===vpFiltro) &&
        (gerenciaFiltro==='todas' || r.ger===gerenciaFiltro) &&
        (supFiltro==='todas' || r.sup===supFiltro)
      ), [universe, vpFiltro, gerenciaFiltro, supFiltro]);

      const kpi = useMemo(() => {
        const total = filtered.length;
        const vig = filtered.filter(r=>r.estado==='vigente').length;
        const ven = filtered.filter(r=>r.estado==='vencido').length;
        const base = Math.max(1, vig+ven);
        return { total, vig, ven, pctVig:+(vig*100/base).toFixed(1), pctVen:+(ven*100/base).toFixed(1) };
      }, [filtered]);

      const dataVpStack =
        Object.values(filtered.reduce((acc, r)=>{
          if(!acc[r.vp]) acc[r.vp]={name:r.vp, Vigentes:0, Vencidos:0};
          if(r.estado==='vigente') acc[r.vp].Vigentes++;
          else acc[r.vp].Vencidos++;
          return acc;
        },{}));

      if(error){
        return (
          <div className="flex justify-center items-center h-screen">
            <div className="bg-red-200 text-red-800 px-6 py-3 rounded-lg text-lg">
              ❌ {error}
            </div>
          </div>
        );
      }

      if(!raw){
        return (
          <div className="flex justify-center items-center h-screen text-gray-600">
            <i data-lucide="loader-2" className="w-6 h-6 mr-2 spin"></i>
            Cargando datos...
          </div>
        );
      }

      return (
        <div className="max-w-7xl mx-auto p-6">
          <h1 className="text-3xl font-bold mb-8">Informe de Certificaciones</h1>

          {/* FILTROS */}
          <div className="bg-white shadow rounded p-5 mb-6">
            <h2 className="font-semibold mb-4 text-lg">Filtros</h2>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Vicepresidencia</label>
                <select
                  value={vpFiltro}
                  onChange={(e) => setVpFiltro(e.target.value)}
                  className="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  <option value="todas">Todas</option>
                  {vps.sort().map(vp => <option key={vp} value={vp}>{vp}</option>)}
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Gerencia</label>
                <select
                  value={gerenciaFiltro}
                  onChange={(e) => setGerenciaFiltro(e.target.value)}
                  className="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  <option value="todas">Todas</option>
                  {gers.sort().map(g => <option key={g} value={g}>{g}</option>)}
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Superintendencia</label>
                <select
                  value={supFiltro}
                  onChange={(e) => setSupFiltro(e.target.value)}
                  className="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  <option value="todas">Todas</option>
                  {sups.sort().map(s => <option key={s} value={s}>{s}</option>)}
                </select>
              </div>

            </div>
            {(vpFiltro !== 'todas' || gerenciaFiltro !== 'todas' || supFiltro !== 'todas') && (
              <button
                onClick={() => { setVpFiltro('todas'); setGerenciaFiltro('todas'); setSupFiltro('todas'); }}
                className="mt-4 px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-sm font-medium"
              >
                Limpiar filtros
              </button>
            )}
          </div>

          {/* CARD KPIs */}
          <div className="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-8">
            <div className="bg-white shadow rounded p-5 border-l-4 border-blue-500">
              <div className="text-sm text-gray-600 mb-1">Total</div>
              <div className="text-3xl font-bold">{kpi.total}</div>
            </div>
            <div className="bg-white shadow rounded p-5 border-l-4 border-green-500">
              <div className="text-sm text-gray-600 mb-1">Vigentes</div>
              <div className="text-3xl font-bold text-green-600">{kpi.vig}</div>
              <div className="text-sm text-gray-500">{kpi.pctVig}%</div>
            </div>
            <div className="bg-white shadow rounded p-5 border-l-4 border-red-500">
              <div className="text-sm text-gray-600 mb-1">Vencidas</div>
              <div className="text-3xl font-bold text-red-600">{kpi.ven}</div>
              <div className="text-sm text-gray-500">{kpi.pctVen}%</div>
            </div>
            <div className="bg-white shadow rounded p-5 border-l-4 border-purple-500">
              <div className="text-sm text-gray-600 mb-1">Filtros Activos</div>
              <div className="text-3xl font-bold">
                {[vpFiltro !== 'todas', gerenciaFiltro !== 'todas', supFiltro !== 'todas'].filter(Boolean).length}
              </div>
            </div>
          </div>

          {/* GRÁFICO BASE */}
          {filtered.length === 0 ? (
            <div className="bg-yellow-50 border border-yellow-200 text-yellow-800 px-6 py-4 rounded-lg">
              ⚠️ No hay datos que mostrar con los filtros seleccionados.
            </div>
          ) : (
            <div className="bg-white shadow rounded p-5">
              <h2 className="font-semibold mb-3 text-lg">Vigentes vs Vencidos por VP</h2>

            <ResponsiveContainer width="100%" height={300}>
              <BarChart data={dataVpStack}>
                <CartesianGrid strokeDasharray="3 3"/>
                <XAxis dataKey="name"/>
                <YAxis/>
                <Tooltip/>
                <Legend/>
                <Bar dataKey="Vigentes" fill="#10B981"/>
                <Bar dataKey="Vencidos" fill="#EF4444"/>
              </BarChart>
            </ResponsiveContainer>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<Informe/>);
  </script>
</body>
</html>
