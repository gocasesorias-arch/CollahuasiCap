<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard de Certificaciones</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide (iconos) -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>

  <style>
    /* Estilo simple para contenedor y botón flotante */
    .fab {
      position: fixed;
      top: 14px;
      left: 14px;
      z-index: 50;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- Botón esquina superior izquierda -->
  <button id="openBtn" class="fab rounded-full p-3 bg-emerald-700 hover:bg-emerald-800 shadow-lg text-white"
          title="Abrir dashboard" aria-label="Abrir dashboard">
    <i data-lucide="chart-bar"></i>
  </button>

  <!-- Encabezado / portada inicial -->
  <header id="cover"
          class="min-h-[40vh] grid place-items-center text-center px-6">
    <div>
      <h1 class="text-3xl font-bold">Dashboard de Certificaciones</h1>
      <p class="mt-2 text-gray-600">Haz clic en el botón con el icono de gráfico (arriba a la izquierda) para cargar datos.</p>
      <p class="mt-1 text-xs text-gray-500">Fuente JSON pública (GitHub Raw).</p>
    </div>
  </header>

  <!-- Contenido del dashboard -->
  <main id="dash" class="max-w-7xl mx-auto px-4 pb-12 hidden">
    <!-- KPIs -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="kpiCards">
      <!-- Tarjetas se llenan por JS -->
    </section>

    <!-- Gráficos -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="bg-white rounded-2xl p-4 shadow">
        <h2 class="font-semibold mb-2">Estado de certificaciones</h2>
        <canvas id="estadoPie" height="220"></canvas>
      </div>

      <div class="bg-white rounded-2xl p-4 shadow">
        <h2 class="font-semibold mb-2">Certificaciones por tipo</h2>
        <canvas id="certBar" height="220"></canvas>
      </div>

      <div class="bg-white rounded-2xl p-4 shadow">
        <h2 class="font-semibold mb-2">Distribución por Vicepresidencia</h2>
        <canvas id="vpBar" height="220"></canvas>
      </div>

      <div class="bg-white rounded-2xl p-4 shadow">
        <h2 class="font-semibold mb-2">Vencimientos por mes</h2>
        <canvas id="venciLine" height="220"></canvas>
      </div>
    </section>

    <!-- Logs / errores -->
    <section class="mt-6" id="logBox" hidden>
      <div class="bg-amber-50 border border-amber-200 text-amber-900 rounded-xl p-3 text-sm" id="logMsg"></div>
    </section>
  </main>

  <script>
    // -------- Config --------
    const jsonUrl = "https://raw.githubusercontent.com/gocasesorias-arch/CollahuasiCap/main/tableConvert.com_jt1fa1.json";

    // Colores corporativos sugeridos
    const COLOR_OK = "#00563F";   // verde corporativo
    const COLOR_WARN = "#E87722"; // naranja corporativo
    const COLOR_BAD = "#C73E3A";  // rojo riesgo

    // Charts refs para poder destruirlos al re-render
    let chartEstado, chartCert, chartVP, chartVenci;

    // Helpers ----------
    const by = (k) => (a,b) => (a[k] > b[k]) ? 1 : (a[k] < b[k]) ? -1 : 0;

    function safeParseRecords(json) {
      // Soporta {records:[...]} o directamente [...]
      if (Array.isArray(json)) return json;
      if (json && Array.isArray(json.records)) return json.records;
      // A veces tableconvert trae {data:{...}} u otra envoltura
      if (json && json.data && Array.isArray(json.data)) return json.data;
      return [];
    }

    function normalizeRow(row) {
      // Normaliza claves esperadas desde tu dataset original
      return {
        Estado: (row["Estado"] || row["estado"] || "").toString().trim().toUpperCase(),
        Certificado: (row["Certificado"] || row["certificado"] || "").toString().trim(),
        Vicepresidencia: (row["Vicepresidencia"] || row["vicepresidencia"] || "").toString().trim(),
        Gerencia: (row["Gerencia"] || row["gerencia"] || "").toString().trim(),
        FechaTermino: (row["Fecha Termino Vigencia"] || row["Fecha termino vigencia"] || row["fecha_termino_vigencia"] || row["FechaTermino"] || "").toString().trim()
      };
    }

    function countBy(arr, key) {
      const map = new Map();
      arr.forEach(o => {
        const k = (o[key] ?? "").toString().trim() || "(Sin dato)";
        map.set(k, (map.get(k) || 0) + 1);
      });
      return map;
    }

    function monthKey(dateStr) {
      // Devuelve YYYY-MM para agrupar
      const d = new Date(dateStr);
      if (isNaN(d)) return "(Fecha inválida)";
      const y = d.getUTCFullYear();
      const m = String(d.getUTCMonth() + 1).padStart(2, "0");
      return `${y}-${m}`;
    }

    function countByMonth(arr, dateKey) {
      const map = new Map();
      arr.forEach(o => {
        const k = monthKey(o[dateKey]);
        map.set(k, (map.get(k) || 0) + 1);
      });
      // ordenar por clave (YYYY-MM)
      return Array.from(map.entries()).sort(([a],[b]) => a.localeCompare(b));
    }

    function topN(map, n = 10) {
      return Array.from(map.entries())
                  .sort((a,b) => b[1]-a[1])
                  .slice(0, n);
    }

    function setLog(msg) {
      const box = document.getElementById("logBox");
      const el = document.getElementById("logMsg");
      if (!msg) { box.hidden = true; el.textContent=""; return; }
      el.textContent = msg;
      box.hidden = false;
    }

    function renderKPIs(records) {
      const total = records.length;
      const vig = records.filter(r => r.Estado === "VIGENTE").length;
      const ven = records.filter(r => r.Estado === "VENCIDA").length;
      const soon = records.filter(r => {
        // pronto a vencer: dentro de 90 días
        const d = new Date(r.FechaTermino);
        if (isNaN(d)) return false;
        const now = new Date();
        const diffDays = Math.round((d - now) / (1000*60*60*24));
        return diffDays >= 0 && diffDays <= 90;
      }).length;

      const KPIs = [
        { label: "Vigentes", value: vig, color: COLOR_OK },
        { label: "Vencidas", value: ven, color: COLOR_BAD },
        { label: "Pronto a vencer (≤90d)", value: soon, color: COLOR_WARN },
        { label: "Total", value: total, color: "#111827" }
      ];

      const wrap = document.getElementById("kpiCards");
      wrap.innerHTML = KPIs.map(k => `
        <div class="bg-white rounded-2xl p-4 shadow border border-gray-100">
          <div class="text-sm text-gray-500">${k.label}</div>
          <div class="mt-1 text-3xl font-semibold" style="color:${k.color}">${k.value}</div>
        </div>
      `).join("");
    }

    function destroyIf(chartRef) { if (chartRef) chartRef.destroy(); }

    function renderCharts(records) {
      // Estado
      const estadoMap = countBy(records, "Estado");
      const estadoLabels = Array.from(estadoMap.keys());
      const estadoData = Array.from(estadoMap.values());
      destroyIf(chartEstado);
      chartEstado = new Chart(
        document.getElementById("estadoPie"),
        {
          type: "pie",
          data: {
            labels: estadoLabels,
            datasets: [{ data: estadoData }]
          },
          options: {
            plugins: { legend: { position: "bottom" } }
          }
        }
      );

      // Certificado (Top 12)
      const certTop = topN(countBy(records, "Certificado"), 12);
      destroyIf(chartCert);
      chartCert = new Chart(
        document.getElementById("certBar"),
        {
          type: "bar",
          data: {
            labels: certTop.map(([k]) => k),
            datasets: [{ label: "Cantidad", data: certTop.map(([,v]) => v) }]
          },
          options: {
            indexAxis: "y",
            plugins: { legend: { display: false } },
            scales: { x: { beginAtZero: true } }
          }
        }
      );

      // Vicepresidencia
      const vpMap = countBy(records, "Vicepresidencia");
      destroyIf(chartVP);
      chartVP = new Chart(
        document.getElementById("vpBar"),
        {
          type: "bar",
          data: {
            labels: Array.from(vpMap.keys()),
            datasets: [{ label: "Cantidad", data: Array.from(vpMap.values()) }]
          },
          options: {
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
          }
        }
      );

      // Vencimientos por mes (línea)
      const validDates = records.filter(r => r.FechaTermino && !isNaN(new Date(r.FechaTermino)));
      const byMonth = countByMonth(validDates, "FechaTermino");
      destroyIf(chartVenci);
      chartVenci = new Chart(
        document.getElementById("venciLine"),
        {
          type: "line",
          data: {
            labels: byMonth.map(([k]) => k),
            datasets: [{ label: "Vencimientos", data: byMonth.map(([,v]) => v), tension: 0.2 }]
          },
          options: {
            plugins: { legend: { display: false } },
            scales: {
              y: { beginAtZero: true }
            }
          }
        }
      );
    }

    async function loadAndRender() {
      setLog("");
      try {
        const res = await fetch(jsonUrl, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();
        const rows = safeParseRecords(json).map(normalizeRow);

        if (!rows.length) {
          setLog("No se encontraron registros en el JSON. Verifica la estructura o la URL.");
          return;
        }

        // Mostrar dashboard
        document.getElementById("cover").classList.add("hidden");
        document.getElementById("dash").classList.remove("hidden");

        renderKPIs(rows);
        renderCharts(rows);
      } catch (err) {
        console.error(err);
        setLog("Error cargando el JSON. Revisa la URL pública o la estructura del archivo.");
      }
    }

    // Botón abrir/cargar
    document.getElementById("openBtn").addEventListener("click", loadAndRender);

    // Render iconos Lucide
    window.addEventListener("DOMContentLoaded", () => {
      lucide.createIcons();
    });
  </script>
</body>
</html>
